- name: Install user pods backend
  when: "'control_plane' in group_names"
  block:
    - name: Install user pods backend, copy persistent volume manifest (1/6)
      ansible.builtin.template:
        src: "{{ backend_manifests_dir }}/read_only_PVs.yaml.j2"
        dest: /etc/kubernetes/custom_manifests/read_only_PVs.yaml
        owner: root
        group: root
        mode: 0640

    - name: Install user pods backend, apply persistent volume manifest (2/6)
      kubernetes.core.k8s:
        kubeconfig: "{{ k8s_admin_config }}"
        apply: True
        src: /etc/kubernetes/custom_manifests/read_only_PVs.yaml
        wait: True

    - name: Install user pods backend, copy user pods backend manifest (3/6)
      ansible.builtin.template:
        src: "{{ backend_manifests_dir }}/deploy_user_pods_backend.yaml.j2"
        dest: /etc/kubernetes/custom_manifests/deploy_user_pods_backend.yaml
        owner: root
        group: root
        mode: 0640

    - name: Install user pods backend, apply user pods backend manifest (4/6)
      kubernetes.core.k8s:
        kubeconfig: "{{ k8s_admin_config }}"
        apply: True
        src: /etc/kubernetes/custom_manifests/deploy_user_pods_backend.yaml
        wait: True


    - name: Install user pods backend, copy testing manifest (5/6)
      ansible.builtin.template:
        src: "{{ backend_manifests_dir }}/deploy_user_pods_backend_testing.yaml.j2"
        dest: /etc/kubernetes/custom_manifests/deploy_user_pods_backend_testing.yaml
        owner: root
        group: root
        mode: 0640

    - name: Install user pods backend, apply testing manifest (6/6)
      kubernetes.core.k8s:
        kubeconfig: "{{ k8s_admin_config }}"
        apply: True
        src: /etc/kubernetes/custom_manifests/deploy_user_pods_backend_testing.yaml
        wait: True
