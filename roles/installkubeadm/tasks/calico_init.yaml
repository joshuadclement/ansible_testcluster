- name: Check calico installed
  when: "'control_plane' in group_names"
  ansible.builtin.shell: kubectl calico version | grep "Cluster Version"
  failed_when: False
  changed_when: False
  register: calico_result
  
- name: Install Calico in control_plane
  when:
    - "'control_plane' in group_names"
    - calico_result.stdout_lines | count == 0
  block:
    - name: Install calico, add helm repo (1/5)
      kubernetes.core.helm_repository:
        name: projectcalico
        repo_url: "https://projectcalico.docs.tigera.io/charts"

    - name: Install calico, copy values (2/5)
      ansible.builtin.template:
        src: "{{ role_path }}/templates/calico_helm_values.yaml.j2"
        dest: /etc/kubernetes/helm_values/calico.yaml
        owner: root
        group: root
        mode: 0640

    - name: Install calico, install chart (3/5)
      kubernetes.core.helm:
        update_repo_cache: True
        release_name: calico
        release_namespace: tigera-operator
        create_namespace: True
        chart_ref: projectcalico/tigera-operator
        atomic: True
        chart_version: "{{ calico_version }}"
        values_files:
          - /etc/kubernetes/helm_values/calico.yaml
        wait: True

    - name: Install Calico, fetch calicoctl (4/5)
      ansible.builtin.get_url:
        url: "{{ calicoctl_url }}"
        checksum: "{{ calicoctl_checksum }}"
        dest: /usr/local/bin/kubectl-calico
        mode: 0751
        owner: root
        group: root

    - name: Install Calico, sleep before continuing (5/5)
      # There are calico-apiserver and calico-system components that are indirectly created by the tigera-operator pod,
      # so the helm command doesn't wait for them to reach ready state.
      ansible.builtin.shell: sleep 45
